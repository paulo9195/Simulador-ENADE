<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ENADE-Psi 2025 — Plataforma de Estudos com IA Gemini</title>
    <!-- Bibliotecas para Geração de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary-color: #6366f1; --secondary-color: #8b5cf6; --accent-color: #06b6d4;
            --success-color: #10b981; --warning-color: #f59e0b; --error-color: #ef4444;
            --text-primary: #1f2937; --text-secondary: #6b7280; --bg-primary: #ffffff;
            --bg-secondary: #f9fafb; --border-color: #e5e7eb;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6;
            color: var(--text-primary); background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; margin-bottom: 40px; color: white; }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .header p { font-size: 1.2rem; opacity: 0.9; }
        .main-content {
            background: var(--bg-primary); border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden; min-height: 600px; margin-bottom: 40px;
        }
        .exam-selection { padding: 40px; text-align: center; }
        .exam-selection h2 { font-size: 2rem; margin-bottom: 30px; color: var(--text-primary); }
        .exam-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .exam-card {
            background: var(--bg-secondary); border: 2px solid var(--border-color); border-radius: 15px;
            padding: 25px; cursor: pointer; transition: all 0.3s ease; text-align: left;
        }
        .exam-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.15); }
        .exam-card.selected { border-color: var(--primary-color); background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; }
        .exam-card h3 { font-size: 1.3rem; margin-bottom: 15px; }
        .exam-card p { font-size: 0.95rem; opacity: 0.8; }
        .start-button {
            background: linear-gradient(135deg, var(--success-color), var(--accent-color)); color: white; border: none;
            padding: 15px 40px; font-size: 1.1rem; border-radius: 50px; cursor: pointer; transition: all 0.3s ease;
            margin: 10px; opacity: 0.5; pointer-events: none;
        }
        .start-button.active { opacity: 1; pointer-events: auto; }
        .start-button:hover.active { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
        .quiz-container { display: none; padding: 40px; }
        .quiz-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid var(--border-color); }
        .quiz-info { display: flex; gap: 30px; align-items: center; }
        .timer { background: var(--error-color); color: white; padding: 10px 20px; border-radius: 25px; font-weight: bold; font-size: 1.1rem; }
        .progress-bar { background: var(--border-color); height: 8px; border-radius: 4px; overflow: hidden; margin-bottom: 30px; }
        .progress-fill { background: linear-gradient(90deg, var(--primary-color), var(--accent-color)); height: 100%; transition: width 0.3s ease; }
        .question-container { background: var(--bg-secondary); border-radius: 15px; padding: 30px; margin-bottom: 30px; }
        .question-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .question-number { background: var(--primary-color); color: white; padding: 8px 16px; border-radius: 20px; font-weight: bold; }
        .question-type { background: var(--accent-color); color: white; padding: 5px 12px; border-radius: 15px; font-size: 0.9rem; }
        .question-text { font-size: 1.1rem; line-height: 1.8; margin-bottom: 25px; color: var(--text-primary); }
        .ai-hint-button {
            background: linear-gradient(135deg, var(--warning-color), #f97316); color: white; border: none;
            padding: 8px 15px; font-size: 0.9rem; border-radius: 20px; cursor: pointer; transition: all 0.3s ease; margin-left: auto;
        }
        .ai-hint-button:hover { transform: scale(1.05); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .ai-hint-box {
            background: #fffbe6; border: 1px solid #fde68a; border-left: 5px solid var(--warning-color);
            border-radius: 8px; padding: 20px; margin-top: 20px; font-size: 0.95rem; color: var(--text-secondary); text-align: left;
        }
        .options-container { display: grid; gap: 15px; }
        .option {
            background: white; border: 2px solid var(--border-color); border-radius: 10px; padding: 15px 20px;
            cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; text-align: left;
        }
        .option:hover { border-color: var(--primary-color); background: #f0f9ff; }
        .option.selected { border-color: var(--primary-color); background: linear-gradient(135deg, #dbeafe, #e0e7ff); }
        .option-letter {
            background: var(--primary-color); color: white; width: 30px; height: 30px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 15px; flex-shrink: 0;
        }
        .option.selected .option-letter { background: var(--success-color); }
        .essay-textarea {
            width: 100%; min-height: 200px; padding: 20px; border: 2px solid var(--border-color);
            border-radius: 10px; font-size: 1rem; line-height: 1.6; resize: vertical; font-family: inherit;
        }
        .essay-textarea:focus { outline: none; border-color: var(--primary-color); }
        .navigation { display: flex; justify-content: space-between; align-items: center; margin-top: 30px; }
        .nav-button {
            background: var(--primary-color); color: white; border: none; padding: 12px 25px;
            border-radius: 25px; cursor: pointer; font-size: 1rem; transition: all 0.3s ease;
        }
        .nav-button:hover { background: var(--secondary-color); transform: translateY(-2px); }
        .nav-button:disabled { background: var(--text-secondary); cursor: not-allowed; transform: none; }
        .finish-button { background: linear-gradient(135deg, var(--success-color), var(--accent-color)); font-weight: bold; padding: 15px 30px; }
        .results-container { display: none; padding: 40px; }
        .results-header { text-align: center; margin-bottom: 40px; }
        .results-header h2 { font-size: 2.5rem; color: var(--success-color); margin-bottom: 10px; }
        .loading-message { text-align: center; padding: 40px; font-size: 1.2rem; color: var(--text-secondary); }
        .spinner {
            border: 4px solid var(--border-color); border-top: 4px solid var(--primary-color); border-radius: 50%;
            width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .results-content, .flashcards-content { background: var(--bg-secondary); border-radius: 15px; padding: 30px; margin-bottom: 30px; text-align: left; }
        .score-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .score-card { background: white; border-radius: 10px; padding: 20px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .score-value { font-size: 2rem; font-weight: bold; color: var(--primary-color); }
        .score-label { color: var(--text-secondary); margin-top: 5px; }
        .action-buttons { display: flex; gap: 15px; justify-content: center; margin-top: 30px; flex-wrap: wrap; }
        .action-button {
            background: var(--primary-color); color: white; border: none; padding: 12px 25px;
            border-radius: 25px; cursor: pointer; font-size: 1rem; transition: all 0.3s ease;
            text-decoration: none; display: inline-flex; align-items: center; gap: 8px; margin: 5px;
        }
        .action-button:hover { background: var(--secondary-color); transform: translateY(-2px); }
        .download-button { background: linear-gradient(135deg, var(--warning-color), #f97316); }
        .notebooklm-button, .flashcard-button { background: linear-gradient(135deg, var(--accent-color), var(--primary-color)); }
        .flashcards-container { margin-top: 30px; }
        .flashcard { background: white; border: 1px solid var(--border-color); border-radius: 10px; margin-bottom: 15px; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .flashcard-front, .flashcard-back { padding-bottom: 10px; }
        .flashcard-front { font-weight: bold; color: var(--primary-color); border-bottom: 1px dashed var(--border-color); margin-bottom: 10px; }
        footer { text-align: center; padding: 20px; color: white; font-size: 0.9rem; opacity: 0.8; }
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .header h1 { font-size: 2rem; }
            .quiz-header, .quiz-info, .navigation, .action-buttons { flex-direction: column; gap: 15px; }
            .exam-grid { grid-template-columns: 1fr; }
            .action-button { width: 100%; max-width: 300px; justify-content: center; }
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        .question-text strong { color: var(--primary-color); }
        .question-text br { margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🧠 ENADE-Psi 2025</h1>
            <p>Plataforma de Estudos Inteligente com IA</p>
        </div>

        <div class="main-content">
            <!-- Seleção de Prova -->
            <div id="examSelection" class="exam-selection">
                <h2>Escolha sua Prova</h2>
                <p style="margin-bottom: 30px; color: var(--text-secondary);">Questões do ENADE com dicas e análise por IA</p>
                <div class="exam-grid">
                    <div class="exam-card" data-exam="formacao_geral">
                        <h3>📚 Formação Geral</h3>
                        <p>Questões de conhecimentos gerais, direitos humanos, realidade brasileira e mundial e temas contemporâneos.</p>
                    </div>
                    <div class="exam-card" data-exam="componente_especifico">
                        <h3>🧠 Componente Específico</h3>
                        <p>Questões focadas nas grandes áreas da Psicologia: teorias, métodos, psicopatologia e avaliação.</p>
                    </div>
                    <div class="exam-card" data-exam="pratica_profissional">
                        <h3>💼 Prática Profissional</h3>
                        <p>Estudos de caso e situações-problema sobre atuação em saúde, educação, organizações e ética profissional.</p>
                    </div>
                    <div class="exam-card" data-exam="prova_completa">
                        <h3>🎯 Prova Completa</h3>
                        <p>Simulado completo com questões de formação geral, componente específico e prática profissional.</p>
                    </div>
                </div>
                <div class="action-buttons">
                    <button id="startButton" class="start-button">Iniciar Simulado</button>
                    <!-- Botão de Histórico Removido -->
                    <a href="https://notebooklm.google.com/notebook/70c43d36-c741-44ea-9303-51470fbbd107" target="_blank" class="action-button notebooklm-button">🚀 NotebookLM Especialista</a>
                </div>
            </div>

            <!-- Container do Quiz -->
            <div id="quizContainer" class="quiz-container">
                <div class="quiz-header">
                    <div class="quiz-info">
                        <h2 id="examTitle">Prova ENADE-Psi</h2>
                        <div id="timer" class="timer">00:00</div>
                    </div>
                    <div id="questionCounter">Questão 1 de 17</div>
                </div>
                <div class="progress-bar"><div id="progressFill" class="progress-fill" style="width: 5.8%"></div></div>
                <div id="questionContainer" class="question-container"></div>
                <div class="navigation">
                    <button id="prevButton" class="nav-button" disabled>⬅️ Anterior</button>
                    <button id="nextButton" class="nav-button">Próximo ➡️</button>
                    <button id="finishButton" class="nav-button finish-button" style="display: none;">🏁 Finalizar</button>
                </div>
            </div>

            <!-- Container de Resultados -->
            <div id="resultsContainer" class="results-container">
                <div class="results-header">
                    <h2>📊 Resultados do Simulado</h2>
                    <p>Análise detalhada e personalizada com IA</p>
                </div>
                <div id="loadingMessage" class="loading-message">
                    <div class="spinner"></div>
                    <p>Analisando suas respostas com a IA...</p>
                    <p style="font-size: 0.9rem; margin-top: 10px;">Isso pode levar alguns segundos.</p>
                </div>
                <div id="resultsContent" class="results-content" style="display: none;"></div>
                <div id="flashcardsContainer" class="flashcards-container" style="display: none;">
                    <h2 style="text-align:center; margin-bottom: 20px;">📇 Flashcards de Estudo Personalizados</h2>
                    <div id="flashcardsContent" class="flashcards-content"></div>
                </div>
                <div class="action-buttons">
                    <a href="https://notebooklm.google.com/notebook/70c43d36-c741-44ea-9303-51470fbbd107" target="_blank" class="action-button notebooklm-button">🚀 Aprofundar no NotebookLM Especialista</a>
                    <button id="flashcardButton" class="action-button flashcard-button" style="display: none;">📇 Gerar Flashcards de Estudo</button>
                    <button id="downloadAnalysisButton" class="action-button download-button" style="display: none;">📄 Baixar Análise em PDF</button>
                    <button id="downloadFlashcardsButton" class="action-button download-button" style="display: none;">📇 Baixar Flashcards em PDF</button>
                    <button id="newExamButton" class="action-button">🔄 Nova Prova</button>
                    <button id="backToHomeButton" class="action-button">🏠 Voltar ao Início</button>
                </div>
            </div>
            
            <!-- Container do Histórico Removido -->
        </div>
    </div>
    <footer>
        <p>© 2025 ENADE-Psi. Todos os direitos reservados. Paulo Henrique Moreira Gonçalves. | Última atualização: 30/08/2025</p>
    </footer>

    <script>
        // --- CONFIGURAÇÃO DA API GEMINI ---
        const GEMINI_API_KEY = "AIzaSyCysbzil5GfHYmgtPh_ZhYKIeaD5CURQnk";
        const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent";

        // --- BANCO DE QUESTÕES ---
        const allQuestions = {
            formacao_geral: [
                { id: "FG_M1", type: "multipla_escolha", text: `A Declaração Universal dos Direitos Humanos (1948) estabelece que "todos os seres humanos nascem livres e iguais em dignidade e em direitos". No contexto brasileiro, qual dos seguintes desafios representa uma violação direta desse princípio?`, options: ["A alta carga tributária.", "A desigualdade racial e social.", "A burocracia para novas empresas.", "A polarização política.", "A complexidade do sistema eleitoral."], correct: 1 },
                { id: "FG_M2", type: "multipla_escolha", text: `O conceito de "Indústria 4.0" refere-se à quarta revolução industrial. Qual das seguintes opções é uma consequência social direta dessa revolução?`, options: ["Aumento da produção agrícola familiar.", "Valorização de profissões manuais.", "A necessidade de requalificação profissional.", "Diminuição do uso da internet.", "O fim da automação."], correct: 2 },
                { id: "FG_D1", type: "discursiva", text: `<strong>TEXTO 1</strong><br>O Relatório Mundial sobre Desigualdade de Gênero 2023 do Fórum Econômico Mundial aponta que, no ritmo atual, serão necessários 131 anos para atingir a paridade total de gênero. <strong>TEXTO 2</strong><br>No Brasil, a Lei Maria da Penha é um marco na luta contra a violência doméstica, mas os índices de feminicídio permanecem alarmantes.<br><br>Com base nos textos, disserte sobre a persistência da desigualdade de gênero no Brasil, abordando: a) a relação entre desigualdade estrutural e violência; b) o papel da educação na desconstrução de estereótipos.` },
            ],
            componente_especifico: [
                { id: "CE_M1", type: "multipla_escolha", text: `No Behaviorismo Radical, um comportamento fortalecido pela remoção de um estímulo aversivo é exemplo de:`, options: ["Reforço positivo.", "Punição positiva.", "Punição negativa.", "Reforço negativo.", "Extinção."], correct: 3 },
                { id: "CE_M2", type: "multipla_escolha", text: `Segundo Piaget, a capacidade de pensar de forma abstrata e hipotético-dedutiva é característica do estágio:`, options: ["Sensório-motor.", "Pré-operatório.", "Operatório concreto.", "Operatório formal.", "Pós-formal."], correct: 3 },
                { id: "CE_D1", type: "discursiva", text: `Um paciente de 35 anos busca terapia com queixas de ansiedade social. Descreva como a Terapia Cognitivo-Comportamental (TCC) abordaria este caso, explicando: a) o modelo cognitivo do transtorno; b) duas técnicas que poderiam ser utilizadas.` },
            ],
            pratica_profissional: [
                { id: "PP_M1", type: "multipla_escolha", text: `Um psicólogo escolar é informado por um aluno de 14 anos que sofre violência física em casa. Qual a conduta correta?`, options: ["Manter sigilo absoluto.", "Conversar com os pais e pedir que mudem.", "Notificar imediatamente o Conselho Tutelar.", "Aconselhar o aluno a fugir.", "Ignorar a denúncia."], correct: 2 },
                { id: "PP_M2", type: "multipla_escolha", text: `Ao elaborar um laudo psicológico para fins judiciais, o psicólogo deve:`, options: ["Usar linguagem subjetiva e jargões.", "Apresentar conclusões sobre fatos que não observou.", "Limitar-se a descrever os instrumentos.", "Fundamentar sua análise em métodos reconhecidos e ser claro e objetivo.", "Incluir informações íntimas não relevantes."], correct: 3 },
                { id: "PP_D1", type: "discursiva", text: `Você é psicólogo(a) em um CRAS e atende uma família cujo filho adolescente apresenta evasão escolar e atos infracionais. Descreva sua proposta de intervenção, considerando: a) a articulação com a rede (escola, Conselho Tutelar); b) uma estratégia de atuação junto à família.` },
            ]
        };
        
        // Simulação com menos questões para testes rápidos
        // Object.keys(allQuestions).forEach(key => {
        //    allQuestions[key] = allQuestions[key].slice(0, 3); 
        // });

        const examData = {
            formacao_geral: { title: "Formação Geral", timeLimit: 10, questions: allQuestions.formacao_geral },
            componente_especifico: { title: "Componente Específico", timeLimit: 10, questions: allQuestions.componente_especifico },
            pratica_profissional: { title: "Prática Profissional", timeLimit: 10, questions: allQuestions.pratica_profissional },
            prova_completa: { title: "Prova Completa", timeLimit: 20, questions: [
                ...allQuestions.formacao_geral,
                ...allQuestions.componente_especifico,
                ...allQuestions.pratica_profissional,
            ]}
        };
        
        let currentExam = null, currentQuestionIndex = 0, userAnswers = {}, timeRemaining = 0, timerInterval = null, examStartTime = null, weakTopics = [];
        
        const examSelection = document.getElementById('examSelection'), quizContainer = document.getElementById('quizContainer'),
              resultsContainer = document.getElementById('resultsContainer'),
              questionContainer = document.getElementById('questionContainer'), examCards = document.querySelectorAll('.exam-card'),
              startButton = document.getElementById('startButton'), prevButton = document.getElementById('prevButton'),
              nextButton = document.getElementById('nextButton'), finishButton = document.getElementById('finishButton'),
              timerEl = document.getElementById('timer'), progressFill = document.getElementById('progressFill'),
              questionCounter = document.getElementById('questionCounter'), examTitle = document.getElementById('examTitle'),
              flashcardButton = document.getElementById('flashcardButton'), downloadAnalysisButton = document.getElementById('downloadAnalysisButton'),
              downloadFlashcardsButton = document.getElementById('downloadFlashcardsButton'), flashcardsContainer = document.getElementById('flashcardsContainer');

        document.addEventListener('DOMContentLoaded', initializeApp);

        function initializeApp() {
            setupEventListeners();
            console.log('ENADE-Psi 2025 Plataforma de Estudos carregada!');
        }

        function setupEventListeners() {
            examCards.forEach(card => card.addEventListener('click', () => selectExam(card)));
            startButton.addEventListener('click', startExam);
            prevButton.addEventListener('click', previousQuestion);
            nextButton.addEventListener('click', nextQuestion);
            finishButton.addEventListener('click', finishExam);
            downloadAnalysisButton.addEventListener('click', () => downloadPDF('resultsContent', 'analise-enade-psi'));
            downloadFlashcardsButton.addEventListener('click', () => downloadPDF('flashcardsContent', 'flashcards-enade-psi'));
            document.getElementById('newExamButton').addEventListener('click', startNewExam);
            document.getElementById('backToHomeButton').addEventListener('click', backToHome);
            flashcardButton.addEventListener('click', generateFlashcards);
        }

        function selectExam(card) {
            examCards.forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            currentExam = examData[card.dataset.exam];
            startButton.classList.add('active');
            startButton.textContent = `Iniciar ${currentExam.title}`;
        }

        function startExam() {
            if (!currentExam) return;
            examSelection.style.display = 'none';
            quizContainer.style.display = 'block';
            examTitle.textContent = currentExam.title;
            timeRemaining = currentExam.timeLimit * 60;
            examStartTime = new Date();
            userAnswers = {};
            currentQuestionIndex = 0;
            weakTopics = [];
            startTimer();
            renderQuestion();
            updateProgress();
        }
        
        function startNewExam() {
            window.location.reload();
        }

        function backToHome() {
            quizContainer.style.display = 'none';
            resultsContainer.style.display = 'none';
            examSelection.style.display = 'block';
            examCards.forEach(c => c.classList.remove('selected'));
            startButton.classList.remove('active');
            startButton.textContent = 'Iniciar Simulado';
            currentExam = null;
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    finishExam();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            timerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function renderQuestion() {
            const question = currentExam.questions[currentQuestionIndex];
            const isLastQuestion = currentQuestionIndex === currentExam.questions.length - 1;
            questionCounter.textContent = `Questão ${currentQuestionIndex + 1} de ${currentExam.questions.length}`;
            let html = `<div class="question-header">
                <span class="question-number">Questão ${currentQuestionIndex + 1}</span>
                <span class="question-type">${question.type === 'multipla_escolha' ? 'Múltipla Escolha' : 'Discursiva'}</span>
                <button class="ai-hint-button" onclick="getAIHint(this)">💡 Pedir Dica da IA</button>
            </div>
            <div class="question-text">${question.text}</div>
            <div id="aiHintBox-${question.id}" class="ai-hint-box" style="display: none;"></div>`;
            if (question.type === 'multipla_escolha') {
                html += '<div class="options-container">';
                question.options.forEach((option, index) => {
                    const letter = String.fromCharCode(65 + index);
                    html += `<div class="option ${userAnswers[question.id] === letter ? 'selected' : ''}" data-option="${letter}">
                        <div class="option-letter">${letter}</div><div class="option-text">${option}</div></div>`;
                });
                html += '</div>';
            } else {
                html += `<textarea class="essay-textarea" placeholder="Digite sua resposta aqui...">${userAnswers[question.id] || ''}</textarea>`;
            }
            questionContainer.innerHTML = html;
            questionContainer.classList.remove('fade-in');
            setTimeout(() => questionContainer.classList.add('fade-in'), 10);
            if (question.type === 'multipla_escolha') {
                document.querySelectorAll('.option').forEach(opt => opt.addEventListener('click', () => selectOption(opt)));
            } else {
                document.querySelector('.essay-textarea').addEventListener('input', (e) => userAnswers[question.id] = e.target.value);
            }
            prevButton.disabled = currentQuestionIndex === 0;
            nextButton.style.display = isLastQuestion ? 'none' : 'inline-block';
            finishButton.style.display = isLastQuestion ? 'inline-block' : 'none';
        }

        function selectOption(el) {
            const id = currentExam.questions[currentQuestionIndex].id;
            userAnswers[id] = el.dataset.option;
            document.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
            el.classList.add('selected');
        }

        function previousQuestion() { if (currentQuestionIndex > 0) { currentQuestionIndex--; renderQuestion(); updateProgress(); } }
        function nextQuestion() { if (currentQuestionIndex < currentExam.questions.length - 1) { currentQuestionIndex++; renderQuestion(); updateProgress(); } }
        function updateProgress() { progressFill.style.width = `${((currentQuestionIndex + 1) / currentExam.questions.length) * 100}%`; }
        
        async function callGemini(prompt) {
            const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            if (!response.ok) {
                const errorBody = await response.text();
                throw new Error(`API Error: ${response.status} - ${errorBody}`);
            }
            const data = await response.json();
            if (!data.candidates || !data.candidates[0].content) {
                throw new Error("Resposta da API em formato inválido ou bloqueada.");
            }
            return data.candidates[0].content.parts[0].text;
        }

        async function getAIHint(button) {
            const question = currentExam.questions[currentQuestionIndex];
            const hintBox = document.getElementById(`aiHintBox-${question.id}`);
            button.disabled = true; hintBox.style.display = 'block';
            hintBox.innerHTML = '<div class="spinner"></div><p>Gerando dica...</p>';
            const prompt = `Sou um estudante de Psicologia. Analise a seguinte questão: "${question.text.replace(/<[^>]*>/g, '')}". Forneça apenas dicas e caminhos de raciocínio, sem entregar a resposta final.`;
            try {
                hintBox.innerHTML = (await callGemini(prompt)).replace(/\n/g, '<br>');
            } catch (error) {
                console.error('Erro ao buscar dica:', error);
                hintBox.innerHTML = `<p style="color: var(--error-color);">Não foi possível obter a dica. Verifique o console para mais detalhes. (${error.message})</p>`;
                button.disabled = false;
            }
        }
        
        function finishExam() { clearInterval(timerInterval); quizContainer.style.display = 'none'; resultsContainer.style.display = 'block'; processResults(); }

        async function processResults() {
            document.getElementById('loadingMessage').style.display = 'block';
            document.getElementById('resultsContent').style.display = 'none';
            flashcardButton.style.display = 'none'; downloadAnalysisButton.style.display = 'none'; downloadFlashcardsButton.style.display = 'none';
            
            const stats = calculateBasicStats();
            
            const weakQuestionsSummary = currentExam.questions
                .filter(q => (q.type === 'multipla_escolha' && userAnswers[q.id] !== String.fromCharCode(65 + q.correct)) || (q.type === 'discursiva' && (!userAnswers[q.id] || userAnswers[q.id].trim() === '')))
                .map(q => ({ id: q.id, text: q.text.replace(/<[^>]*>/g, '').substring(0, 100) + '...' }));
            
            const prompt = `Você é um professor especialista em ENADE de Psicologia. Analise o desempenho do aluno:
            - Prova: ${currentExam.title}; Tempo: ${stats.timeSpent} min; Objetivas: ${stats.correctAnswers}/${stats.totalMultipleChoice} (${stats.score}%); Discursivas: ${stats.essayQuestions}/${stats.totalEssayQuestions}.
            - Questões com erro ou não respondidas: ${JSON.stringify(weakQuestionsSummary)}.
            - Respostas discursivas do aluno: ${JSON.stringify(Object.fromEntries(Object.entries(userAnswers).filter(([key]) => key.includes('_D'))))}.
            Faça uma análise detalhada em HTML, usando tags como <h3> para títulos e <ul>/<li> para listas: 1. Diagnóstico geral do desempenho. 2. Seus Pontos Fortes (com base nos temas das questões acertadas). 3. Pontos a Melhorar (com base nos temas das questões erradas). 4. Recomendações de estudo personalizadas e diretas.`;

            try {
                const aiAnalysis = await callGemini(prompt);
                displayResults(stats, aiAnalysis);
            } catch(error) {
                console.error("Erro na análise da IA:", error);
                displayResults(stats, `<h3 style="color: var(--error-color);">Erro na Análise</h3><p>Ocorreu um erro ao gerar a análise detalhada. Seus resultados foram salvos. Detalhes: ${error.message}</p>`);
            }
        }

        function calculateBasicStats() {
            let correctAnswers = 0, totalMultipleChoice = 0, essayQuestions = 0, totalEssayQuestions = 0;
            weakTopics = [];
            currentExam.questions.forEach(q => {
                const userAnswer = userAnswers[q.id];
                if (q.type === 'multipla_escolha') {
                    totalMultipleChoice++;
                    const correctAnswer = String.fromCharCode(65 + q.correct);
                    if (userAnswer === correctAnswer) {
                        correctAnswers++;
                    } else {
                        weakTopics.push(q.text.replace(/<[^>]*>/g, '').substring(0, 80));
                    }
                } else {
                    totalEssayQuestions++;
                    if (userAnswer && userAnswer.trim() !== '') {
                        essayQuestions++;
                    } else {
                         weakTopics.push(q.text.replace(/<[^>]*>/g, '').substring(0, 80));
                    }
                }
            });
            const score = totalMultipleChoice > 0 ? Math.round((correctAnswers / totalMultipleChoice) * 100) : 0;
            const timeSpent = Math.round((new Date() - examStartTime) / 1000 / 60);
            return { score, correctAnswers, totalMultipleChoice, essayQuestions, totalEssayQuestions, timeSpent };
        }

        function displayResults(stats, aiAnalysis) {
            document.getElementById('loadingMessage').style.display = 'none';
            const resultsContent = document.getElementById('resultsContent');
            resultsContent.style.display = 'block';
            resultsContent.innerHTML = `<div class="score-summary">
                <div class="score-card"><div class="score-value">${stats.score}%</div><div class="score-label">Aproveitamento</div></div>
                <div class="score-card"><div class="score-value">${stats.correctAnswers}/${stats.totalMultipleChoice}</div><div class="score-label">Acertos</div></div>
                <div class="score-card"><div class="score-value">${stats.essayQuestions}/${stats.totalEssayQuestions}</div><div class="score-label">Discursivas</div></div>
                <div class="score-card"><div class="score-value">${stats.timeSpent} min</div><div class="score-label">Tempo Gasto</div></div>
            </div>${aiAnalysis}`;
            if (weakTopics.length > 0) {
                flashcardButton.style.display = 'inline-flex';
            }
            downloadAnalysisButton.style.display = 'inline-flex';
        }
        
        async function downloadPDF(elementId, filename) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            const { jsPDF } = window.jspdf;
            const canvas = await html2canvas(element, { scale: 2 });
            const imgData = canvas.toDataURL('image/png');
            
            const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const imgProps = pdf.getImageProperties(imgData);
            const imgHeight = (imgProps.height * pdfWidth) / imgProps.width;
            
            pdf.addImage(imgData, 'PNG', 10, 10, pdfWidth - 20, imgHeight - 20);
            pdf.save(`${filename}.pdf`);
        }

        async function generateFlashcards() {
            flashcardButton.disabled = true;
            flashcardButton.innerHTML = '<div class="spinner" style="width:20px; height:20px; border-width: 2px; margin: 0 auto;"></div>';
            flashcardsContainer.style.display = 'block';
            const flashcardsContent = document.getElementById('flashcardsContent');
            flashcardsContent.innerHTML = '<div class="spinner"></div><p>Gerando flashcards com base nos seus erros...</p>';
            
            const prompt = `Com base nos seguintes tópicos onde um aluno errou em um simulado de psicologia (${weakTopics.join('; ')}), crie exatamente 5 flashcards concisos para estudo. Use o formato: "Frente: [Pergunta/Conceito] Verso: [Resposta/Explicação]". Separe cada flashcard claramente.`;
            
            try {
                const response = await callGemini(prompt);
                let flashcardsHTML = response.split(/Frente:/i).filter(Boolean).map(card => {
                    const parts = card.split(/Verso:/i);
                    const front = parts[0] ? parts[0].trim() : 'Não foi possível gerar a frente.';
                    const back = parts[1] ? parts[1].trim() : 'Não foi possível gerar o verso.';
                    return `<div class="flashcard"><div class="flashcard-front"><strong>Frente:</strong> ${front}</div><div class="flashcard-back"><strong>Verso:</strong> ${back}</div></div>`;
                }).join('');
                flashcardsContent.innerHTML = flashcardsHTML;
                downloadFlashcardsButton.style.display = 'inline-flex';
            } catch (error) {
                console.error('Erro ao gerar flashcards:', error);
                flashcardsContent.innerHTML = `<p style="color: var(--error-color);">Não foi possível gerar os flashcards. (${error.message})</p>`;
            } finally {
                flashcardButton.disabled = false;
                flashcardButton.innerHTML = '📇 Gerar Flashcards de Estudo';
            }
        }
    </script>
</body>
</html>
